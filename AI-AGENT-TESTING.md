# AI Agent ??測試??

## 概述

??檔說??Excel Tools 節點? AI Agent ??測試套件，??自??言輸入????位?射??誤??等測試場??

## 測試?件結?

```
nodes/ExcelAI/
??? ExcelAI.node.ts           # 主?點實?
??? ExcelAI.node.test.ts      # ???能測試
??? ExcelAI.ai-agent.test.ts  # AI Agent ??測試
```

## 測試套件說?

### 1. AI Agent ??測試 (`ExcelAI.node.test.ts`)

#### 測試範?

- **AI Agent ????**
  - 驗? `usableAsTool` 屬?
  - 測試?然語??數?收
  - ?次????
  - ?誤訊息清晰?

- **?然語?輸入??**
  - JSON ????
  - ???資???
  - ?濾條件??
  - 嵌??件??

- **??欄???**
  - ??欄?對?
  - 中?標??援
  - 多種輸入????
  - 缺失欄???
  - ??欄???

- **?誤??**
  - ?件不???
  - 工?表?存在
  - ?? JSON 輸入
  - Excel 檔???
  - 權???
  - 行數超出範?
  - ???濾條件
  - 缺?必??數
  - 二進制資??誤
  - 中??誤訊息
  - 並發存??誤
  - continueOnFail 模?
  - 資?類?驗?

- **??測試**
  - 完整 CRUD 循環
  - AI Agent 多?作工作??

### 2. AI Agent ???景測試 (`ExcelAI.ai-agent.test.ts`)

#### 測試範?

- **?然語?輸入??**
  - ??中??然語??述??
  - ??模??????述（?天、??、?年?
  - ??多?言混?輸入（中?、英?、日??
  - ???????述（幾?、?多、???
  - ??條件?輯?自??言表?

- **??欄???**
  - ??不????????對?（snake_case?camelCase?kebab-case?PascalCase?中??
  - ??嵌??件?平???
  - ???能類?轉?
  - ??欄??稱?義詞???
  - ????????
  - ??缺失欄??能填?

- **AI Agent 複?工?流?**
  - ??多步驟數?????
  - ???於上???決?
  - ???次?能??
  - ??條件??作?

- **?誤???恢?*
  - ??結??錯誤??
  - ???????批次??
  - ??詳細??證錯誤???
  - ???誤後?試??
  - ??詳細?誤上?????

- **?能?擴展?*
  - ??大???讀???測試?1000+ 筆?
  - ??流???大??
  - ??快???請?

## ??測試

### ????測?

```bash
npm test
```

### ?????能測試

```bash
npm run test:unit
```

### ?? AI Agent ??測試

```bash
npm run test:ai
```

### ???模???測試

```bash
npm run test:watch
```

### ??測試覆??報??

```bash
npm run test:coverage
```

### 詳細輸出模?

```bash
npm run test:verbose
```

## 測試案?詳解

### ?然語?輸入測試

#### 案? 1: 中??然語??述

```typescript
const naturalLanguageInput = `請添??筆員工???
  姓??張小??
  年齡??8歲?
  ?????部?
  ????體工程師?
  ????0000?`;

// AI Agent 將其????構???
const parsedData = {
  姓?: '張???,
  年齡: 28,
  ??: '?發??,
  ??: '軟?工??,
  ??: 70000,
};
```

**測試??**: 驗?節點能?收 AI Agent ??後?結??數??

#### 案? 2: 模?????

```typescript
const scenarios = [
  { input: '今天', parsed: '2024-12-23' },
  { input: '下週?', parsed: '2024-12-30' },
  { input: '?年一??, parsed: '2025-01-01' },
];
```

**測試??**: AI Agent 將自??言??轉???準格?

#### 案? 3: 多?言混?

```typescript
const multilingualData = {
  Product_Name: 'iPhone 15 Pro',
  ???稱: 'iPhone 15 Pro',
  価格: 36900,        // ??
  price: 36900,       // ??
  ???リ: 'Electronics',
};
```

**測試??**: ???含多種語?欄??稱?數??

### ??欄???測試

#### 案? 1: ???????對?

```typescript
const namingConventions = [
  { snake_case_field: 'value1' },
  { camelCaseField: 'value2' },
  { 'kebab-case-field': 'value3' },
  { PascalCaseField: 'value4' },
  { 中?欄??? 'value5' },
];
```

**測試??**: ??識別並????命?風??

#### 案? 2: 嵌??件?平??

```typescript
const nestedData = {
  user: {
    profile: { name: '測試?戶', age: 30 },
    contact: { email: 'test@example.com' },
  },
};

// ??平??? user.profile.name, user.contact.email
```

**測試??**: 將?套?構??為平面欄?

#### 案? 3: ?能類?轉?

```typescript
const mixedTypes = {
  ??字串: '12345',      // ??轉為??
  布?字串: 'true',       // ??轉為布???
  ??字串: '2024-12-23', // ??識別?日??
};
```

**測試??**: ???測並???????

### AI Agent 工?流?測試

#### 案?: 多步驟????

```typescript
// Step 1: AI 讀?數??
await excelCrud.execute.call(mockContext); // READ

// Step 2: AI ??並更??
await excelCrud.execute.call(mockContext); // UPDATE

// Step 3: AI ?建總?
await excelCrud.execute.call(mockContext); // CREATE
```

**測試??**: 驗? AI Agent ?串?????

#### 案?: ?於上???決?

```typescript
const performanceRules = [
  { minScore: 90, status: '??' },
  { minScore: 60, status: '?好' },
  { minScore: 0, status: '??? },
];

// AI Agent ??績??數???新???
```

**測試??**: AI ?根?數?內容??智?決?

### ?誤??測試

#### 案? 1: 結??錯誤??

```typescript
try {
  await excelCrud.execute.call(mockContext);
} catch (error) {
  // ?誤????
  // - ?誤類?
  // - ?誤位置
  // - 建議???
}
```

#### 案? 2: ??????

```typescript
// continueOnFail 模?下???失?不影?其他??
const results = await excelCrud.execute.call(mockContext);
// results[0] = { success: true }
// results[1] = { error: '...' }
// results[2] = { success: true }
```

### ?能測試

#### 案?: 大?????

```typescript
// 1000+ 筆???????5 秒內完?
const startTime = Date.now();
const result = await excelCrud.execute.call(mockContext);
const endTime = Date.now();
expect(endTime - startTime).toBeLessThan(5000);
```

## Mock 說?

### Context Mock

```typescript
mockContext = {
  getNode: jest.fn().mockReturnValue({ name: 'ExcelCrud' }),
  getNodeParameter: jest.fn(),
  getInputData: jest.fn().mockReturnValue([{ json: {} }]),
  helpers: {
    assertBinaryData: jest.fn(),
    getBinaryDataBuffer: jest.fn(),
  },
  continueOnFail: jest.fn().mockReturnValue(false),
};
```

### File System Mock

```typescript
(fs.readFile as jest.Mock).mockResolvedValue(Buffer.from(''));
(fs.writeFile as jest.Mock).mockResolvedValue(undefined);
```

## 測試覆??目?

- **語句覆???(Statement)**: > 80%
- **?支覆???(Branch)**: > 75%
- **?數覆???(Function)**: > 90%
- **行??? (Line)**: > 80%

## ????

測試?在以????????

1. Git push ??
2. Pull Request 建???
3. ?併?主?支??

## 測試?佳實?

1. **測試??**: 使用?述??中?測試?稱
2. **測試?離**: 每個測試獨立執行?互?影響
3. **Mock 使用**: ?當使用 Mock ??外部依賴
4. **?誤??**: ??測試?種?誤??
5. **??條件**: 測試????極端??
6. **?能??**: ?含?能??測試

## ???除

### 測試失???檢查清單

1. ??確? Node.js ?本 (建議 18+)
2. ???? `npm install` 安?依賴
3. ??檢查 TypeScript 編譯?否??
4. ????詳細?誤訊息 (`npm run test:verbose`)
5. ??確?測試??變數設?

### 常???

#### Q: 測試超?

```bash
# 增?測試超???
jest.setTimeout(30000);
```

#### Q: Mock 不???

```bash
# 確???beforeEach 中正確設?Mock
jest.clearAllMocks();
```

#### Q: 測試檔?沒???

```bash
# 檢查檔??稱?否符? *.test.ts ??*.spec.ts
```

## ??資?

- [Jest 官方??](https://jestjs.io/)
- [n8n 節點????](https://docs.n8n.io/)
- [ExcelJS ??](https://github.com/exceljs/exceljs)
- [TypeScript 測試?佳實踐](https://github.com/goldbergyoni/javascript-testing-best-practices)

## 貢獻??

??測試???循以?步??

1. ?適??測試?件中新增測試??
2. 確?測試案??????述
3. 添?必???Mock 設?
4. ??測試確???
5. ?新此?檔說?新增?測試

## ??

MIT License

---

?後更?? 2024-12-23

